{% extends 'Template.html' %}

{% block title %}{{ foro.titulo }}{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
<style>
    /* Modo oscuro */
    .dark-mode {
        background-color: #2c2f33;
        color: #f8f9fa;
    }

    .dark-mode .dark-card {
        background-color: #3c4043;
    }
    .dark-mode .list-group-item {
        color: #f8f9fa !important;
    }
    .dark-mode .dark-card-body {
        background-color: #2c2f33;
    }

    .dark-mode .dark-text {
        color: #f8f9fa !important;
    }

    .dark-mode .text-muted {
        color: #888 !important;
    }

    /* Modo claro */
    .light-mode {
        background-color: white;
        color: #333;
    }

    .light-mode .dark-card {
        background-color: #f8f9fa;
    }

    .light-mode .dark-card-body {
        background-color: #ffffff;
    }

    .light-mode .dark-text {
        color: #333 !important;
    }

    .light-mode .text-muted {
        color: #555 !important;
    }

    /* Asegurarse de que el fondo y los textos sean legibles en modo oscuro */
    .dark-card-body {
        background-color: #2c2f33;
        color: #f8f9fa;
    }
    .light-mode .sticky-bar {
    background-color: #f8f9fa;
    border: 1px solid #ccc;
    color: #333; /* Color de texto en modo claro */
    }

    .dark-mode .sticky-bar {
        background-color: #2c2f33;
        border: 1px solid #444;
        color: #f8f9fa; /* Color de texto en modo oscuro */
    }
    .dark-mode .sticky-bar textarea {
    background-color: #3c4043;
    color: #f8f9fa;
    border: 1px solid #444;
    }


    .dark-mode .sticky-bar {
        background-color: #2c2f33;
        border: 1px solid #444;
        color: #f8f9fa;
    }

    .dark-mode #image-preview {
        background-color: #3c4043;
        color: #f8f9fa;
        border: 1px solid #555;
    }

    .dark-mode #image-preview img {
        background-color: #3c4043;
    }
    /* Estilo para la vista previa de la imagen */
#image-preview {
    display: none; /* Se oculta por defecto */
    position: relative;
    top: -20px;
    background-color: #f8f9fa;
    padding: 10px;
    border-radius: 5px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    max-width: 200px;
}

#image-preview img {
    max-height: 100px;
    object-fit: cover;
    border-radius: 5px;
}

.btn-remove-preview {
    position: absolute;
    top: 5px;
    right: 5px;
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    border: none;
    border-radius: 50%;
    padding: 3px 7px;
    font-size: 12px;
    cursor: pointer;
    line-height: 1; /* Ajuste para que el botón sea perfectamente circular */
}

    /* Estilo dinámico para la barra de comentarios */
    .sticky-bar {
        position: sticky;
        bottom: 0;
        background-color: white;
        padding: 10px;
        z-index: 10;
    }

    /* Barra de comentarios con modo claro y oscuro */
    .light-mode .sticky-bar {
        background-color: #f8f9fa;
        border: 1px solid #ccc;
    }

    .dark-mode .sticky-bar {
        background-color: #2c2f33;
        border: 1px solid #444;
    }
        /* Modo oscuro */
    .dark-mode .form-container textarea {
        background-color: #3c4043; /* Fondo oscuro para el modo oscuro */
        color: #f8f9fa; /* Texto claro */
    }

    /* Modo claro */
    .light-mode .form-container textarea {
        background-color: #ffffff; /* Fondo blanco para el modo claro */
        color: #333; /* Texto oscuro */
    }
    .form-container {
        position: relative;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        margin-top: 20px;
    }

    /* Campo de texto para el comentario */
    .input-group {
        display: flex;
        align-items: center;
        width: 100%;
    }

    .input-group textarea {
        flex-grow: 1;
        min-width: 200px; /* Asegura que el área de texto no se estire demasiado */
    }

    .input-group button {
        margin-left: 10px;
        width: auto; /* Evita que el botón se estire */
    }

    /* Vista previa de la imagen al lado izquierdo */
    #image-preview {
        display: flex;
        justify-content: space-between;
        max-width: 200px; /* Limitar el ancho */
    }

    .form-container button {
        width: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1>{{ foro.titulo }}</h1>
    <p class="dark-text">{{ foro.descripcion }}</p>
    <small class="text-muted">Creado por {{ foro.creador.nombres }} {{ foro.creador.apellidos }} el {{ foro.fecha_creacion }}</small>

    <h3 class="mt-4">Comentarios</h3>
    <ul class="list-group">
        {% for comentario in comentarios %}
            <li class="list-group-item {% if comentario.autor == request.user %}bg-light{% endif %} dark-card">
                <div>
                    <strong class="dark-text">{{ comentario.autor.nombres }} {{ comentario.autor.apellidos }}</strong>
                    <p class="dark-text">{{ comentario.contenido }}</p>

                    <!-- Contenedor para la fecha en la esquina inferior derecha -->
                    <small class="text-muted" style="position: absolute; right: 10px; bottom: 10px;">{{ comentario.fecha_creacion }}</small>

                    <!-- Mostrar archivo adjunto, si existe -->
                    {% if comentario.archivo %}
                        <div class="mt-2">
                            <a href="{{ comentario.archivo.url }}" class="btn btn-link" download>
                                Descargar archivo
                            </a>
                            <div class="mt-1">
                                <img src="{{ comentario.archivo.url }}" class="img-fluid rounded shadow" alt="Archivo adjunto" style="max-height: 150px; object-fit: cover;">
                            </div>
                        </div>
                    {% endif %}

                    <!-- Botón para mostrar/ocultar respuestas -->
                    <button class="btn btn-link dark-text" type="button" data-bs-toggle="collapse" data-bs-target="#respuestas-{{ comentario.id }}" aria-expanded="false" aria-controls="respuestas-{{ comentario.id }}">
                        Ver Respuestas ({{ comentario.respuestas.count }})
                    </button>

                    <!-- Contenedor de respuestas colapsable -->
                    <div class="collapse" id="respuestas-{{ comentario.id }}">
                        <ul class="list-group mt-2">
                            {% for respuesta in comentario.respuestas.all %}
                                <li class="list-group-item {% if respuesta.autor == request.user %}bg-light{% endif %} dark-card">
                                    <strong class="dark-text">{{ respuesta.autor.nombres }} {{ respuesta.autor.apellidos }}</strong> - {{ respuesta.contenido }}
                                    <small class="text-muted">{{ respuesta.fecha_creacion }}</small>
                                </li>
                            {% empty %}
                                <li class="list-group-item dark-card">No hay respuestas aún.</li>
                            {% endfor %}
                        </ul>
                    </div>

                    <!-- Botón para mostrar el formulario de respuesta -->
                    <button class="btn btn-secondary mt-2" onclick="toggleRespuestaForm('form-respuesta-{{ comentario.id }}')">Responder</button>

                    <!-- Formulario de respuesta oculto -->
                    <div id="form-respuesta-{{ comentario.id }}" style="display:none;">
                        {% if user.is_authenticated %}
                            <form method="POST" class="mt-2">
                                {% csrf_token %}
                                <input type="hidden" name="parent_id" value="{{ comentario.id }}">
                                <textarea name="contenido" class="form-control" rows="2" placeholder="Añade una respuesta..."></textarea>
                                <button type="submit" class="btn btn-secondary mt-1">Enviar Respuesta</button>
                            </form>
                        {% else %}
                           <p class="text-muted">
                            <a href="{% url 'login' %}">Inicia sesión para poder comentar</a>
                           </p>
                        {% endif %}
                    </div>
                </div>
            </li>
        {% empty %}
            <li class="list-group-item dark-card">No hay comentarios aún.</li>
        {% endfor %}
    </ul>

    <!-- Barra de comentario compacta y dinámica -->
    {% if user.is_authenticated %}
        <form method="POST" enctype="multipart/form-data" class="border p-2 rounded bg shadow-sm sticky-bar">
            {% csrf_token %}

            <!-- Vista previa de la imagen (solo se muestra si hay imagen) -->
            <div id="image-preview" class="d-flex justify-content-between" style="display:none;">
                <img id="preview" src="#" alt="Preview" class="img-fluid rounded" style="max-height: 100px; object-fit: cover;">
                <button type="button" class="btn-remove-preview" onclick="removeImage()">×</button>
            </div>

            <!-- Campo de texto para el comentario -->
            <div class="input-group w-100 mt-2">
                <textarea name="contenido" id="id_contenido" class="form-control" rows="1" placeholder="Añade un comentario..." required></textarea>
                <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('id_archivo').click();">
                    <i class="bi bi-arrow-up"></i>
                </button>
                <input type="file" name="archivo" id="id_archivo" class="d-none" accept="image/*" onchange="previewImage(event)">
            </div>

            <!-- Botón para enviar el comentario -->
            <button type="submit" class="btn btn-primary mt-2 w-100">Enviar Comentario</button>
        </form>
    {% else %}
        <p class="text-muted">
            <a href="{% url 'login' %}">Inicia sesión para poder comentar</a>
        </p>
    {% endif %}
</div>

<script>
    function toggleRespuestaForm(id) {
        const form = document.getElementById(id);
        form.style.display = (form.style.display === 'none') ? 'block' : 'none';
    }

    function previewImage(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        const previewImg = document.getElementById('preview');
        const imagePreview = document.getElementById('image-preview');

        if (file) {
            reader.onload = function() {
                previewImg.src = reader.result;
                imagePreview.style.display = 'flex'; // Mostrar la vista previa
            };
            reader.readAsDataURL(file);
        } else {
            removeImage();
        }
    }

    function removeImage() {
        const fileInput = document.getElementById('id_archivo');
        fileInput.value = '';
        document.getElementById('preview').src = '';
        document.getElementById('image-preview').style.display = 'none'; // Ocultar la vista previa
    }
</script>

{% endblock %}
